<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Список користувачів</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fa; padding: 20px; }
    h1 { text-align: center; color: #343a40; margin-bottom: 20px; }
    .search-container { display: flex; justify-content: center; margin-bottom: 20px; }
    .search-container input { width: 300px; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; }
    .search-container input:focus { border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.5); }
    table { width: 90%; margin: 0 auto; border-collapse: collapse; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
    th { background: #343a40; color: white; text-transform: uppercase; }
    tr:hover { background: #f1f3f5; }
    .delete-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
    .delete-btn:hover { background: #b02a37; }
    .avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 10px; vertical-align: middle; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: white; padding: 25px; border-radius: 12px; width: 350px; max-width: 90%; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease; }
    .modal h3 { margin-bottom: 15px; font-size: 18px; color: #212529; }
    .modal p { font-size: 15px; color: #495057; margin-bottom: 20px; }
    .modal button { margin: 0 8px; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.3s; }
    .btn-yes { background: #28a745; color: white; }
    .btn-yes:hover { background: #218838; }
    .btn-cancel { background: #6c757d; color: white; }
    .btn-cancel:hover { background: #5a6268; }
    #loader { text-align: center; color:#007bff; font-weight:bold; display:none; margin-bottom:10px; }
    #noResults { display:none; text-align:center; color:#6c757d; margin-top:15px; }
    @keyframes fadeIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>
  <h1>Список користувачів</h1>

  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Введіть ім'я, прізвище або email...">
  </div>

  <div id="loader">Завантаження...</div>
  <table>
    <thead>
      <tr>
        <th>Id</th>
        <th>Фото</th>
        <th>Ім'я</th>
        <th>Email</th>
        <th>Телефон</th>
        <th>Дія</th>
      </tr>
    </thead>
    <tbody id="usersTableBody">
      <tr><td colspan="6">Завантаження користувачів...</td></tr>
    </tbody>
  </table>

  <p id="noResults">Нічого не знайдено</p>


  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <h3>Підтвердження видалення</h3>
      <p id="modalText"></p>
      <button class="btn-yes" id="confirmYes">Так</button>
      <button class="btn-cancel" id="confirmCancel">Скасувати</button>
    </div>
  </div>

  <script>
    $(function(){
      const $searchInput = $("#searchInput");
      const $usersTableBody = $("#usersTableBody");
      const $loader = $("#loader");
      const $noResults = $("#noResults");
      let rowToDelete = null;
      let allUsers = [];

      function renderUsers(users) {
        $usersTableBody.empty();
        users.forEach(user => {
          const fullName = `${user.firstName ?? ''} ${user.secondName ?? ''}`.trim();
          const photoUrl = user.photo
            ? `https://lohika.itstep.click/images/100_${user.photo}`
            : "https://via.placeholder.com/50x50?text=Фото";

          const row = $(`
            <tr data-id="${user.id}" data-name="${fullName}">
              <td>${user.id}</td>
              <td><img src="${photoUrl}" class="avatar"></td>
              <td>${fullName}</td>
              <td>${user.email ?? '-'}</td>
              <td>${user.phone ?? '-'}</td>
              <td><button class="delete-btn">Delete</button></td>
            </tr>
          `);
          $usersTableBody.append(row);
        });
      }

      function loadAllUsers() {
        $loader.show();
        $noResults.hide();
        $.get("https://lohika.itstep.click/api/Users/all", function(data){
          $loader.hide();
          if(data && data.length > 0){
            allUsers = data;
            renderUsers(allUsers);
          } else {
            $usersTableBody.html(`<tr><td colspan="6">Користувачів не знайдено</td></tr>`);
          }
        }).fail(function(){
          $loader.hide();
          $usersTableBody.html(`<tr><td colspan="6" style="color:red;">Помилка завантаження</td></tr>`);
        });
      }

      loadAllUsers();

      let typingTimer;
      const typingDelay = 300;
      $searchInput.on("input", function(){
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          const query = $searchInput.val().trim().toLowerCase();
          if(query === "") { renderUsers(allUsers); $noResults.hide(); return; }

          const filtered = allUsers.filter(u => {
            const fullName = `${u.firstName ?? ''} ${u.secondName ?? ''}`.toLowerCase();
            const email = (u.email ?? '').toLowerCase();
            return fullName.includes(query) || email.includes(query);
          });

          if(filtered.length > 0){
            renderUsers(filtered);
            $noResults.hide();
          } else {
            $usersTableBody.empty();
            $noResults.show();
          }
        }, typingDelay);
      });

      $usersTableBody.on("click", ".delete-btn", function(){
        rowToDelete = $(this).closest("tr");
        const userName = rowToDelete.data("name");
        $("#modalText").text(`Ви впевнені, що хочете видалити користувача: "${userName}"?`);
        $("#modalOverlay").fadeIn(200);
      });

      $("#confirmYes").click(function(){
        if(rowToDelete){
          const id = rowToDelete.data("id");
          rowToDelete.remove();
          allUsers = allUsers.filter(u => u.id !== id);
          rowToDelete = null;
        }
        $("#modalOverlay").fadeOut(200);
      });

      $("#confirmCancel, #modalOverlay").click(function(e){
        if(e.target.id === "modalOverlay" || e.target.id === "confirmCancel") {
          rowToDelete = null;
          $("#modalOverlay").fadeOut(200);
        }
      });
    });
  </script>
</body>
</html>
